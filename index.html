<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oso Abrazos - Phaser</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-family: Arial, sans-serif;
        }
        #game-container { 
            border: 2px solid #333; 
            border-radius: 8px; 
            overflow: hidden;
        }
        .loading {
            color: white;
            font-size: 20px;
            text-align: center;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="loading" class="loading">üîÑ Cargando Oso Abrazos...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
    
    <script>
        // ============= CONFIGURACI√ìN GLOBAL =============
       handleEnemyCollision() 
    window.gameState.lives = Math.max(0, window.gameState.lives - 1);
    this.updateUI();
    
    this.oso.setTint(0xff0000);
    this.time.delayedCall(1000, () => {
        if (this.oso) this.oso.clearTint();
    });
    
    this.playSound('hurt');
    
    if (window.gameState.lives <= 0) {
        this.gameOver();
    }
}

updateUI() {
    // PREVENIR ERROR DE REPEAT CON N√öMEROS NEGATIVOS
    const lives = Math.max(0, window.gameState.lives);
    const score = Math.max(0, window.gameState.score);
    const hearts = Math.max(0, window.gameState.heartsCollected);
    
    this.uiText.setText([
        `Nivel: ${this.level}`,
        `Puntos: ${score}`,
        `Vidas: ${'‚ù§Ô∏è'.repeat(lives)}`,
        `Corazones: ${hearts}/3`
    ].join('\n'));
}

setupPhysics() {
    this.physics.add.overlap(this.oso, this.enemies, (oso, enemy) => {
        // AGREGAR INVENCIBILIDAD TEMPORAL
        if (!oso.invincible && !oso.hugging) {
            this.handleEnemyCollision();
            
            // HACER INVENCIBLE POR 2 SEGUNDOS
            oso.invincible = true;
            this.time.delayedCall(2000, () => {
                if (oso) oso.invincible = false;
            });
        }
    });
    // ... resto del c√≥digo
}

        // ============= CLASES DEL JUEGO =============
        class Oso extends Phaser.Physics.Arcade.Sprite {
            constructor(scene, x, y) {
                super(scene, x, y, 'oso_idle');
                scene.add.existing(this);
                scene.physics.add.existing(this);

                this.setCollideWorldBounds(true);
                this.setBounce(0.2);
                this.body.setSize(60, 70);
                this.body.setOffset(10, 10);

                this.hugging = false;
                this.hasUnicorn = false;
                this.invincible = false;
                this.direction = 1;
                this.hugCooldown = 0;

                this.createAnimations();
            }

            createAnimations() {
                this.anims.create({ key: 'idle', frames: [{ key: 'oso_idle' }], frameRate: 10 });
                this.anims.create({ key: 'walk', frames: [{ key: 'oso_walk' }], frameRate: 10 });
                this.anims.create({ key: 'jump', frames: [{ key: 'oso_jump' }], frameRate: 10 });
                this.anims.create({ key: 'hug', frames: [{ key: 'oso_hug' }], frameRate: 10, repeat: 0 });
            }

            update(cursors, spaceKey) {
                if (this.hugging) return;

                // Movimiento horizontal
                if (cursors.left.isDown) {
                    this.setVelocityX(-160);
                    this.direction = -1;
                    this.anims.play('walk', true);
                    this.setFlipX(true);
                } else if (cursors.right.isDown) {
                    this.setVelocityX(160);
                    this.direction = 1;
                    this.anims.play('walk', true);
                    this.setFlipX(false);
                } else {
                    this.setVelocityX(0);
                    this.anims.play('idle', true);
                }

                // Salto
                if (cursors.up.isDown && this.body.touching.down) {
                    this.setVelocityY(-330);
                    this.playSound('jump');
                }

                // Abrazo
                if (Phaser.Input.Keyboard.JustDown(spaceKey) && this.hugCooldown <= 0) {
                    this.hug();
                }

                if (this.hugCooldown > 0) this.hugCooldown--;
            }

            hug() {
                this.hugging = true;
                this.hugCooldown = 30;
                this.setVelocityX(0);
                this.anims.play('hug', true);
                this.playSound('hug');

                this.once('animationcomplete', () => {
                    this.hugging = false;
                    this.anims.play('idle', true);
                });
            }

            playSound(soundName) {
                if (window.gameState.soundEnabled && this.scene.sound.get(soundName)) {
                    this.scene.sound.play(soundName);
                }
            }
        }

        class Enemy extends Phaser.Physics.Arcade.Sprite {
            constructor(scene, x, y, type) {
                super(scene, x, y, `enemy${type}`);
                scene.add.existing(this);
                scene.physics.add.existing(this);

                this.type = type;
                this.direction = -1;
                this.moveCooldown = 0;
                this.speed = [80, 100, 120][type - 1] || 80;
                
                this.setCollideWorldBounds(true);
                this.body.setSize(50, 60);
                this.body.setOffset(5, 5);
                this.setFlipX(true);
            }

            update() {
                if (this.moveCooldown > 0) {
                    this.moveCooldown--;
                    this.setVelocityX(0);
                    return;
                }

                this.setVelocityX(this.speed * this.direction);

                if (this.x <= 50) {
                    this.direction = 1;
                    this.setFlipX(false);
                    this.moveCooldown = 60;
                } else if (this.x >= 750) {
                    this.direction = -1;
                    this.setFlipX(true);
                    this.moveCooldown = 60;
                }
            }
        }

        class Friend extends Phaser.Physics.Arcade.Sprite {
            constructor(scene, x, y, type) {
                const textures = { squirrel: 'squirrel', rabbit: 'rabbit', bird: 'bird' };
                super(scene, x, y, textures[type] || 'squirrel');
                scene.add.existing(this);
                scene.physics.add.existing(this);

                this.type = type;
                this.hugged = false;
                this.floatValue = Math.random() * 100;
                this.floatDir = Math.random() > 0.5 ? 1 : -1;
                
                this.body.setAllowGravity(false);
                this.setImmovable(true);
            }

            update() {
                this.floatValue += 0.05;
                this.y += Math.sin(this.floatValue) * 0.5 * this.floatDir;
            }

            hug() {
                if (this.hugged) return false;
                this.hugged = true;
                this.setTint(0x00ff00);
                
                // Part√≠culas de abrazo
                for (let i = 0; i < 10; i++) {
                    const particle = this.scene.add.circle(
                        this.x + this.width / 2,
                        this.y + this.height / 2,
                        Phaser.Math.Between(2, 5),
                        0xFF69B4
                    );
                    
                    this.scene.tweens.add({
                        targets: particle,
                        x: particle.x + Phaser.Math.Between(-30, 30),
                        y: particle.y + Phaser.Math.Between(-30, 30),
                        alpha: 0,
                        duration: 1000,
                        onComplete: () => particle.destroy()
                    });
                }
                
                return true;
            }
        }

        class Heart extends Phaser.Physics.Arcade.Sprite {
            constructor(scene, x, y) {
                super(scene, x, y, 'heart');
                scene.add.existing(this);
                scene.physics.add.existing(this);

                this.collected = false;
                this.floatValue = Math.random() * 100;
                
                this.body.setAllowGravity(false);
                this.setImmovable(true);
                this.setScale(0.6);
            }

            update() {
                this.floatValue += 0.03;
                this.y += Math.sin(this.floatValue) * 0.3;
            }

            collect() {
                if (this.collected) return false;
                this.collected = true;
                
                // Part√≠culas de colecci√≥n
                for (let i = 0; i < 15; i++) {
                    const particle = this.scene.add.circle(
                        this.x + this.width / 2,
                        this.y + this.height / 2,
                        Phaser.Math.Between(2, 5),
                        0xFF69B4
                    );
                    
                    this.scene.tweens.add({
                        targets: particle,
                        x: particle.x + Phaser.Math.Between(-40, 40),
                        y: particle.y + Phaser.Math.Between(-40, 40),
                        alpha: 0,
                        duration: 1000,
                        onComplete: () => particle.destroy()
                    });
                }
                
                this.destroy();
                return true;
            }
        }

        // ============= ESCENAS DEL JUEGO =============
        class BootScene extends Phaser.Scene {
            constructor() { 
                super({ key: 'BootScene' });
            }

            preload() {
                // Cargar imagen de carga
                this.load.image('loading', 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main/img/oso/oso_portada.png');
            }

            create() {
                console.log('‚úÖ BootScene cargada');
                this.scene.start('PreloadScene');
            }
        }

        class PreloadScene extends Phaser.Scene {
            constructor() { 
                super({ key: 'PreloadScene' });
            }

            preload() {
                this.createProgressBar();
                this.loadAssets();
            }

            createProgressBar() {
                const width = 400, height = 20;
                const x = (800 - width) / 2, y = 400;
                
                // Fondo de la barra
                this.add.rectangle(x, y, width, height, 0x666666).setOrigin(0, 0.5);
                
                // Barra de progreso
                const progressBar = this.add.rectangle(x, y, 0, height, 0x00FF00).setOrigin(0, 0.5);
                
                // Texto de progreso
                const progressText = this.add.text(400, y + 30, '0%', { 
                    fontSize: '18px', 
                    fill: '#fff',
                    fontFamily: 'Arial'
                }).setOrigin(0.5);
                
                // Texto de carga
                this.add.text(400, y - 30, 'Cargando Oso Abrazos...', {
                    fontSize: '20px',
                    fill: '#fff',
                    fontFamily: 'Arial'
                }).setOrigin(0.5);

                this.load.on('progress', (value) => {
                    progressBar.width = width * value;
                    progressText.setText(`${Math.round(value * 100)}%`);
                });
            }

            loadAssets() {
                const baseUrl = 'https://raw.githubusercontent.com/Evelez23/-oso.abrazos-/main';
                
                console.log('üîÑ Cargando assets...');
                
                // SPRITES DEL OSO
                this.load.image('oso_idle', `${baseUrl}/img/oso/oso_idle.svg`);
                this.load.image('oso_walk', `${baseUrl}/img/oso/oso_walk.svg`);
                this.load.image('oso_jump', `${baseUrl}/img/oso/oso_jump.svg`);
                this.load.image('oso_hug', `${baseUrl}/img/oso/oso_hugging.svg`);
                this.load.image('oso_run', `${baseUrl}/img/oso/oso_run.svg`);
                this.load.image('oso_sit', `${baseUrl}/img/oso/oso_sit.svg`);
                this.load.image('osoyuni', `${baseUrl}/img/Amigos/osoyuni.png`);

                // AMIGOS
                this.load.image('squirrel', `${baseUrl}/img/Amigos/ardilla.png`);
                this.load.image('rabbit', `${baseUrl}/img/Amigos/conejo.png`);
                this.load.image('bird', `${baseUrl}/img/Amigos/pajarito.png`);
                this.load.image('heart', `${baseUrl}/img/Amigos/lovepower.png`);
                this.load.image('unicorn', `${baseUrl}/img/Amigos/unirshup.png`);
                this.load.image('honey', `${baseUrl}/img/Amigos/miel.png`);

                // ENEMIGOS
                this.load.image('enemy1', `${baseUrl}/img/enemigos/Enemigos-01.svg`);
                this.load.image('enemy2', `${baseUrl}/img/enemigos/Enemigos-02.svg`);
                this.load.image('enemy3', `${baseUrl}/img/enemigos/Enemigos-03.svg`);
                this.load.image('boss1', `${baseUrl}/img/enemigos/lobo.svg`);
                this.load.image('boss2', `${baseUrl}/img/enemigos/loboferoz.png`);
                this.load.image('boss3', `${baseUrl}/img/enemigos/lobotriste.png`);
                this.load.image('fire', `${baseUrl}/img/enemigos/fire.png`);

                // FONDOS
                this.load.image('forest1', `${baseUrl}/img/fondos/bosque1.jpg`);
                this.load.image('forest2', `${baseUrl}/img/fondos/bosque2.jpg`);
                this.load.image('forest3', `${baseUrl}/img/fondos/bosque3.jpg`);
                this.load.image('forest4', `${baseUrl}/img/fondos/bosque4.jpg`);

                // SONIDOS (placeholders - pueden fallar por CORS)
                try {
                    this.load.audio('background', `${baseUrl}/sounds/background.mp3.mp3`);
                    this.load.audio('jump', `${baseUrl}/sounds/jump.mp3.mp3`);
                    this.load.audio('hug', `${baseUrl}/sounds/hug.mp3.mp3`);
                    this.load.audio('collect', `${baseUrl}/sounds/collect.mp3.mp3`);
                    this.load.audio('hurt', `${baseUrl}/sounds/hurt.mp3.mp3`);
                } catch (error) {
                    console.log('‚ö†Ô∏è Los sonidos pueden fallar por CORS');
                }
            }

            create() {
                console.log('‚úÖ Todos los assets cargados');
                this.scene.start('MenuScene');
            }
        }

        class MenuScene extends Phaser.Scene {
            constructor() { 
                super({ key: 'MenuScene' });
            }

            create() {
                console.log('üéÆ MenuScene iniciada');
                
                // Ocultar loading
                document.getElementById('loading').classList.add('hidden');
                
                // Fondo
                this.add.image(400, 300, 'forest1').setDisplaySize(800, 600);
                
                // T√≠tulo
                this.add.text(400, 150, 'OSO ABRAZOS', {
                    fontSize: '48px',
                    fill: '#fff',
                    stroke: '#000',
                    strokeThickness: 6,
                    fontFamily: 'Arial',
                    fontStyle: 'bold'
                }).setOrigin(0.5);
                
                // Bot√≥n JUGAR
                const playButton = this.add.text(400, 300, 'üéÆ JUGAR', {
                    fontSize: '32px',
                    fill: '#fff',
                    backgroundColor: '#8B4513',
                    padding: { x: 30, y: 15 },
                    fontFamily: 'Arial'
                }).setOrigin(0.5).setInteractive();
                
                // Efectos hover del bot√≥n
                playButton.on('pointerover', () => {
                    playButton.setScale(1.1);
                    playButton.setBackgroundColor('#A0522D');
                });
                
                playButton.on('pointerout', () => {
                    playButton.setScale(1);
                    playButton.setBackgroundColor('#8B4513');
                });
                
                playButton.on('pointerdown', () => {
                    console.log('üöÄ Iniciando juego...');
                    window.gameState.score = 0;
                    window.gameState.lives = 3;
                    window.gameState.heartsCollected = 0;
                    window.gameState.currentLevel = '1-1';
                    this.scene.start('GameScene', { level: '1-1' });
                });
                
                // Cr√©ditos
                this.add.text(400, 550, 'Hecho con ‚ù§Ô∏è y Phaser.js', {
                    fontSize: '14px',
                    fill: '#ccc',
                    fontFamily: 'Arial'
                }).setOrigin(0.5);
            }
        }

        class GameScene extends Phaser.Scene {
            constructor() { 
                super({ key: 'GameScene' });
            }

            init(data) {
                this.level = data.level || '1-1';
                this.levelConfig = this.getLevelConfig();
                console.log(`üéØ Iniciando nivel: ${this.level}`);
            }

            create() {
                window.gameState.gameStarted = true;
                
                this.createBackground();
                this.createPlatforms();
                this.createOso();
                this.createFriends();
                this.createEnemies();
                this.createHearts();
                this.setupPhysics();
                this.setupControls();
                this.createUI();
                
                // Intentar reproducir m√∫sica de fondo
                try {
                    this.backgroundMusic = this.sound.add('background', { loop: true, volume: 0.5 });
                    if (window.gameState.soundEnabled) {
                        this.backgroundMusic.play();
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è M√∫sica de fondo no disponible');
                }
            }

            getLevelConfig() {
                const levels = {
                    '1-1': { friends: 2, enemies: 1, hearts: 1 },
                    '1-2': { friends: 3, enemies: 2, hearts: 1 },
                    '1-3': { friends: 4, enemies: 3, hearts: 2 }
                };
                return levels[this.level] || levels['1-1'];
            }

            createBackground() {
                const bgKey = `forest${this.level.split('-')[1]}`;
                this.add.image(400, 300, bgKey).setDisplaySize(800, 600);
            }

            createPlatforms() {
                this.platforms = this.physics.add.staticGroup();
                
                // Plataforma principal
                this.platforms.create(400, 500, null).setSize(600, 20).setOrigin(0.5, 0.5);
                
                // Plataformas adicionales seg√∫n nivel
                if (this.level === '1-2') {
                    this.platforms.create(200, 400, null).setSize(150, 20).setOrigin(0.5, 0.5);
                    this.platforms.create(600, 400, null).setSize(150, 20).setOrigin(0.5, 0.5);
                } else if (this.level === '1-3') {
                    this.platforms.create(200, 400, null).setSize(150, 20).setOrigin(0.5, 0.5);
                    this.platforms.create(400, 300, null).setSize(200, 20).setOrigin(0.5, 0.5);
                    this.platforms.create(600, 400, null).setSize(150, 20).setOrigin(0.5, 0.5);
                }
            }

            createOso() {
                this.oso = new Oso(this, 100, 400);
                this.physics.add.collider(this.oso, this.platforms);
            }

            createFriends() {
                this.friends = this.physics.add.group();
                const friendTypes = ['squirrel', 'rabbit', 'bird'];
                
                for (let i = 0; i < this.levelConfig.friends; i++) {
                    const type = friendTypes[i % friendTypes.length];
                    const friend = new Friend(
                        this,
                        Phaser.Math.Between(150, 650),
                        Phaser.Math.Between(100, 400),
                        type
                    );
                    this.friends.add(friend);
                }
            }

            createEnemies() {
                this.enemies = this.physics.add.group();
                
                for (let i = 0; i < this.levelConfig.enemies; i++) {
                    const enemyType = Phaser.Math.Between(1, 3);
                    const enemy = new Enemy(
                        this,
                        Phaser.Math.Between(200, 600),
                        400,
                        enemyType
                    );
                    this.enemies.add(enemy);
                }
                
                this.physics.add.collider(this.enemies, this.platforms);
            }

            createHearts() {
                this.hearts = this.physics.add.group();
                
                for (let i = 0; i < this.levelConfig.hearts; i++) {
                    const heart = new Heart(
                        this,
                        Phaser.Math.Between(100, 700),
                        Phaser.Math.Between(100, 300)
                    );
                    this.hearts.add(heart);
                }
            }

            setupPhysics() {
                // Colisi√≥n oso-enemigos
                this.physics.add.overlap(this.oso, this.enemies, (oso, enemy) => {
                    if (!oso.invincible && !oso.hugging) {
                        this.handleEnemyCollision();
                    }
                });

                // Colisi√≥n oso-amigos (al abrazar)
                this.physics.add.overlap(this.oso, this.friends, (oso, friend) => {
                    if (oso.hugging && friend.hug()) {
                        this.handleFriendHug();
                    }
                });

                // Colisi√≥n oso-corazones
                this.physics.add.overlap(this.oso, this.hearts, (oso, heart) => {
                    if (heart.collect()) {
                        this.handleHeartCollection();
                    }
                });
            }

            handleEnemyCollision() {
                window.gameState.lives--;
                this.updateUI();
                
                this.oso.setTint(0xff0000);
                this.time.delayedCall(1000, () => this.oso.clearTint());
                
                this.playSound('hurt');
                
                if (window.gameState.lives <= 0) {
                    this.gameOver();
                }
            }

            handleFriendHug() {
                window.gameState.score += 100;
                this.updateUI();
                this.playSound('collect');
                
                this.checkLevelComplete();
            }

            handleHeartCollection() {
                window.gameState.heartsCollected++;
                window.gameState.score += 50;
                this.updateUI();
                this.playSound('collect');
                
                if (window.gameState.heartsCollected >= 3 && !this.oso.hasUnicorn) {
                    this.activateUnicorn();
                }
            }

            activateUnicorn() {
                this.oso.hasUnicorn = true;
                this.oso.setTexture('osoyuni');
                this.showHint('¬°Unicornio de la Amistad activado!', 3000);
            }

            setupControls() {
                this.cursors = this.input.keyboard.createCursorKeys();
                this.spaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
            }

            createUI() {
                this.uiText = this.add.text(20, 20, '', {
                    fontSize: '18px',
                    fill: '#fff',
                    stroke: '#000',
                    strokeThickness: 4,
                    fontFamily: 'Arial'
                });
                
                this.updateUI();
            }

            updateUI() {
                this.uiText.setText([
                    `Nivel: ${this.level}`,
                    `Puntos: ${window.gameState.score}`,
                    `Vidas: ${'‚ù§Ô∏è'.repeat(window.gameState.lives)}`,
                    `Corazones: ${window.gameState.heartsCollected}/3`
                ].join('\n'));
            }

            playSound(soundName) {
                if (window.gameState.soundEnabled && this.sound.get(soundName)) {
                    try {
                        this.sound.play(soundName);
                    } catch (error) {
                        console.log(`‚ö†Ô∏è Sonido ${soundName} no disponible`);
                    }
                }
            }

            checkLevelComplete() {
                const allHugged = this.friends.getChildren().every(friend => friend.hugged);
                if (allHugged && this.friends.getChildren().length > 0) {
                    this.levelComplete();
                }
            }

            levelComplete() {
                console.log('‚úÖ Nivel completado!');
                
                if (this.backgroundMusic) {
                    this.backgroundMusic.stop();
                }
                
                this.playSound('collect');
                this.showHint('¬°Nivel Completado!', 2000);
                
                this.time.delayedCall(2000, () => {
                    const nextLevel = this.getNextLevel();
                    if (nextLevel) {
                        this.scene.start('GameScene', { level: nextLevel });
                    } else {
                        this.victory();
                    }
                });
            }

            getNextLevel() {
                const levels = ['1-1', '1-2', '1-3'];
                const currentIndex = levels.indexOf(this.level);
                return currentIndex < levels.length - 1 ? levels[currentIndex + 1] : null;
            }

            victory() {
                console.log('üéâ Victoria!');
                this.showHint('¬°Has ganado! üéâ', 3000);
                
                this.time.delayedCall(3000, () => {
                    this.scene.start('MenuScene');
                });
            }

            gameOver() {
                console.log('üíÄ Game Over');
                
                if (this.backgroundMusic) {
                    this.backgroundMusic.stop();
                }
                
                this.showHint('Game Over üíÄ', 3000);
                
                this.time.delayedCall(3000, () => {
                    this.scene.start('MenuScene');
                });
            }

            showHint(text, duration) {
                const hint = this.add.text(400, 300, text, {
                    fontSize: '24px',
                    fill: '#fff',
                    stroke: '#000',
                    strokeThickness: 4,
                    fontFamily: 'Arial'
                }).setOrigin(0.5);
                
                this.tweens.add({
                    targets: hint,
                    alpha: 0,
                    duration: duration,
                    delay: duration / 2,
                    onComplete: () => hint.destroy()
                });
            }

            update() {
                if (this.oso) {
                    this.oso.update(this.cursors, this.spaceKey);
                }
                
                if (this.friends) {
                    this.friends.getChildren().forEach(friend => friend.update());
                }
                
                if (this.enemies) {
                    this.enemies.getChildren().forEach(enemy => enemy.update());
                }
                
                if (this.hearts) {
                    this.hearts.getChildren().forEach(heart => heart.update());
                }
            }
        }

        // ============= INICIALIZACI√ìN DEL JUEGO =============
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            backgroundColor: '#87CEEB',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 800 },
                    debug: false
                }
            },
            scene: [BootScene, PreloadScene, MenuScene, GameScene],
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            }
        };

        // Iniciar el juego
        const game = new Phaser.Game(config);

        // Manejo de errores
        game.events.on('ERROR', (error) => {
            console.error('Error de Phaser:', error);
        });

        console.log('üéÆ Oso Abrazos inicializado!');
    </script>
</body>
</html>
